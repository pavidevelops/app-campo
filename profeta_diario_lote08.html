/**********************
 *  EVIDENTE - LOTE 08
 *  Rotas:
 *   - action=upload_foto
 *   - action=gravar_linha_lt08
 *   - action=list_sheets
 *   - action=list_acts&lots=L08,L09
 *   - action=list_rows&lots=L08,L09&start=YYYY-MM-DD&end=YYYY-MM-DD
 **********************/

// ===== CONFIG =====
const LOTE08_SPREADSHEET_ID = '1jBidnqj8xsycCDbfuITaCuQx-TztxsItoWADXtggmMg';
// Se sua aba consolidada se chama "lt_08", deixe assim. Se for outro nome, troque aqui:
const LOTE08_SHEET_NAME     = 'lt_08';

const LOTE08_DRIVE_FOLDER_ID = '1-RKLrt2mVzZw7A9LpGSVwAv1NfnHyKbO';
const SHARE_PUBLIC_LINK = true;
const USE_IMAGE_FORMULA = true;
const APP_VERSION_DEFAULT = '1.0';
const FILE_NAME_TEMPLATE = '{YYYY}{MM}{DD}_{hh}{mm}{ss}_{usuario}_{uuid}.jpg';

const SCRIPT_PROPS = PropertiesService.getScriptProperties();

// ===== ROUTER =====
function doPost(e) {
  try {
    if (!e || !e.postData) return json({ status: 'ERRO', mensagem: 'Sem postData' }, 400);
    const ct = (e.postData && e.postData.type) || '';
    let params = e.parameter || {};
    if (ct.indexOf('application/json') > -1) { try { params = JSON.parse(e.postData.contents)||params; } catch(_){} }
    const action = String(params.action || '').trim().toLowerCase();
    if (!action) return json({ status: 'ERRO', mensagem: 'Parâmetro action ausente' }, 400);
    switch (action) {
      case 'upload_foto':       return handleUploadFoto(params);
      case 'gravar_linha_lt08': return handleGravarLinhaLT08(params);
      default: return json({ status: 'ERRO', mensagem: 'Ação inválida: ' + action }, 400);
    }
  } catch (err) { return json({ status: 'ERRO', mensagem: String(err) }, 500); }
}

function doGet(e) {
  const p = (e && e.parameter) || {};
  const action = String(p.action || '').toLowerCase().trim();
  try {
    if (!action) return json({ status: 'OK', mensagem: 'Evidente Lote 08 WebApp ativo' }, 200);
    if (action === 'list_sheets') { return json({ status: 'OK', sheets: listSheets_() }, 200); }
    if (action === 'list_acts')   { return json({ status: 'OK', acts: listActs_(String(p.lots||'')) }, 200); }
    if (action === 'list_rows')   {
      const lotsStr  = String(p.lots || '');
      const startISO = String(p.start||'');
      const endISO   = String(p.end  ||'');
      return json({ status: 'OK', rows: listRows_(lotsStr, startISO, endISO) }, 200);
    }
    return json({ status: 'ERRO', mensagem: 'Ação inválida: ' + action }, 400);
  } catch (err) { return json({ status: 'ERRO', mensagem: String(err) }, 500); }
}

// ===== HANDLERS =====
function handleUploadFoto(params) {
  const usuario = (params.usuario || '').trim();
  const codAtv  = (params.cod_atividade || '').trim();
  const atvNome = (params.atividade || '').trim();
  const uuid    = (params.submission_uuid || '').trim();
  let appVersion = (params.app_version || APP_VERSION_DEFAULT).trim();
  let fotoBase64 = (params.foto_base64 || '').trim();

  if (!fotoBase64) return json({ status: 'ERRO', mensagem: 'foto_base64 ausente' }, 400);
  if (!usuario)    return json({ status: 'ERRO', mensagem: 'usuario ausente' }, 400);
  if (!codAtv)     return json({ status: 'ERRO', mensagem: 'cod_atividade ausente' }, 400);
  if (!atvNome)    return json({ status: 'ERRO', mensagem: 'atividade ausente' }, 400);
  if (!uuid)       return json({ status: 'ERRO', mensagem: 'submission_uuid ausente' }, 400);

  const photoKey = 'PHOTO_' + uuid;
  const existingFileId = SCRIPT_PROPS.getProperty(photoKey);
  if (existingFileId) {
    const fotoUrl = SHARE_PUBLIC_LINK ? ('https://drive.google.com/uc?export=view&id=' + existingFileId)
                                      : ('https://drive.google.com/file/d/' + existingFileId + '/view');
    return json({ status: 'OK', foto_url: fotoUrl, foto_id: existingFileId, file_name: '(existing)' }, 200);
  }

  const idx = fotoBase64.indexOf('base64,');
  if (idx !== -1) fotoBase64 = fotoBase64.substring(idx + 'base64,'.length);

  let bytes;
  try { bytes = Utilities.base64Decode(fotoBase64); }
  catch (e) { return json({ status: 'ERRO', mensagem: 'base64 inválido' }, 400); }

  const now = new Date();
  const safeUsuario = sanitizeForFilename(usuario);
  const fileName = formatFileName(FILE_NAME_TEMPLATE, now, safeUsuario, uuid);

  const root = DriveApp.getFolderById(LOTE08_DRIVE_FOLDER_ID);
  const yFolder = getOrCreateSubfolder(root, Utilities.formatDate(now, Session.getScriptTimeZone(), 'yyyy'));
  const mFolder = getOrCreateSubfolder(yFolder, Utilities.formatDate(now, Session.getScriptTimeZone(), 'MM'));
  const dFolder = getOrCreateSubfolder(mFolder, Utilities.formatDate(now, Session.getScriptTimeZone(), 'dd'));

  const blob = Utilities.newBlob(bytes, 'image/jpeg', fileName);
  const file = dFolder.createFile(blob);
  if (SHARE_PUBLIC_LINK) file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  const fileId = file.getId();
  const fotoUrl = SHARE_PUBLIC_LINK ? ('https://drive.google.com/uc?export=view&id=' + fileId)
                                    : ('https://drive.google.com/file/d/' + fileId + '/view');

  SCRIPT_PROPS.setProperty(photoKey, fileId);
  return json({ status: 'OK', foto_url: fotoUrl, foto_id: fileId, file_name: fileName }, 200);
}

function handleGravarLinhaLT08(params) {
  const ss = SpreadsheetApp.openById(LOTE08_SPREADSHEET_ID);
  let sheet = ss.getSheetByName(LOTE08_SHEET_NAME);
  if (!sheet) sheet = ss.insertSheet(LOTE08_SHEET_NAME);

  const rowKey =
    (params.submission_uuid && ('ROW_' + params.submission_uuid)) ||
    (params.foto_id && ('ROW_PHOTO_' + params.foto_id)) || null;

  if (rowKey) {
    const seen = SCRIPT_PROPS.getProperty(rowKey);
    if (seen) return json({ status: 'OK', mensagem: 'Linha já registrada (idem).' }, 200);
  }

  const ts         = parseDateOrNow(params.data_hora);
  const appVersion = (params.app_version || APP_VERSION_DEFAULT).trim();
  const usuario    = (params.usuario || '').trim();
  const codAtv     = (params.cod_atividade || '').trim();
  const atvNome    = (params.atividade || '').trim();
  const obs        = (params.obs || '').trim();
  const chuva      = (params.chuva || '').trim();
  const gpsFlag    = (params.fake_gps || params.gps_flag || '').trim();

  const fotoParam = (params.foto || '').trim();
  const fotoId    = (params.foto_id || '').trim();
  let fotoCellValue = fotoParam;
  if (USE_IMAGE_FORMULA) {
    if (fotoParam.startsWith('=IMAGE(')) {
      fotoCellValue = fotoParam;
    } else if (fotoId) {
      fotoCellValue = '=IMAGE("https://drive.google.com/uc?export=view&id=' + fotoId + '")';
    } else if (fotoParam) {
      fotoCellValue = '=IMAGE("' + fotoParam.replace(/"/g, '""') + '")';
    } else {
      fotoCellValue = '';
    }
  }

  const lat = toNumberOrEmpty(params.lat);
  const lon = toNumberOrEmpty(params.long);

  // Coluna L (texto), aceita "lote" (ex.: "Lote 08") ou "lote_cod" (ex.: "L08")
  const loteFinal = (params.lote && String(params.lote).trim()) || normalizeLoteFromCode_(params.lote_cod) || '';

  const row = [ ts, appVersion, usuario, codAtv, atvNome, fotoCellValue, lat, lon, obs, chuva, gpsFlag, loteFinal ];
  sheet.appendRow(row);

  if (rowKey) SCRIPT_PROPS.setProperty(rowKey, '1');
  return json({ status: 'OK' }, 200);
}

// ===== LISTAGENS =====
function listSheets_() {
  const ss = SpreadsheetApp.openById(LOTE08_SPREADSHEET_ID);
  const sh = ss.getSheetByName(LOTE08_SHEET_NAME);
  if (sh) {
    const last = sh.getLastRow();
    if (last >= 2) {
      const lots = new Set();
      const vals = sh.getRange(2, 12, last - 1, 1).getDisplayValues(); // Coluna L
      vals.forEach(r => {
        const code = normalizeLotTextToCode_(String(r[0] || ''));
        if (code) lots.add(code);
      });
      const out = Array.from(lots);
      if (out.length) return out.sort((a,b)=> a.localeCompare(b,'pt-BR',{numeric:true}));
    }
  }
  // fallback (se quiser listar por abas antigas)
  const out = new Set();
  ss.getSheets().forEach(s => {
    const norm = normalizeLot_(s.getName());
    if (norm) out.add(norm);
  });
  return Array.from(out).sort((a,b)=> a.localeCompare(b,'pt-BR',{numeric:true}));
}

function listActs_(lotsStr) {
  const ss = SpreadsheetApp.openById(LOTE08_SPREADSHEET_ID);
  const sh = ss.getSheetByName(LOTE08_SHEET_NAME);
  const acts = new Set();
  if (sh) {
    const last = sh.getLastRow(); if (last >= 2) {
      const lotsFilter = normalizeLotsCsvToSet_(lotsStr); // 'L08','L09'...
      const rng = sh.getRange(2, 1, last - 1, 12).getDisplayValues(); // A..L
      for (var i = 0; i < rng.length; i++) {
        const row = rng[i];
        const lotCode = normalizeLotTextToCode_(String(row[11] || '')); // L
        if (lotsFilter.size && (!lotCode || !lotsFilter.has(lotCode))) continue;
        const atv = String(row[4] || '').trim(); // E
        if (atv) acts.add(atv);
      }
    }
    return Array.from(acts).sort((a,b)=> a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
  }
  return []; // se não houver consolidado
}

function listRows_(lotsStr, startISO, endISO) {
  const tz = Session.getScriptTimeZone() || 'America/Sao_Paulo';
  const ss = SpreadsheetApp.openById(LOTE08_SPREADSHEET_ID);
  const sh = ss.getSheetByName(LOTE08_SHEET_NAME);
  const out = [];
  const start = startISO ? new Date(startISO + 'T00:00:00') : null;
  const end   = endISO   ? new Date(endISO   + 'T23:59:59') : null;
  const lotsFilter = normalizeLotsCsvToSet_(lotsStr);

  if (sh) {
    const last = sh.getLastRow(); if (last >= 2) {
      const values = sh.getRange(2, 1, last - 1, 12).getValues(); // A..L
      for (var i=0;i<values.length;i++) {
        const r = values[i];
        let ts = r[0]; if (!(ts instanceof Date)) ts = parsePtBrDateTime_(String(ts||'').trim());
        if (!(ts instanceof Date) || isNaN(ts.getTime())) continue;
        if (start && ts < start) continue; if (end && ts > end) continue;

        const lotCode = normalizeLotTextToCode_(String(r[11] || '')); // L
        if (lotsFilter.size && (!lotCode || !lotsFilter.has(lotCode))) continue;

        const atv     = r[4];  // E
        const fotoVal = r[5];  // F
        const chuva   = r[9];  // J
        const gpsFlag = r[10]; // K

        out.push({
          lote: lotCode || '',
          ts: Utilities.formatDate(ts, tz, "yyyy-MM-dd'T'HH:mm:ssXXX"),
          atv: String(atv||''),
          foto: extractImageUrl_(fotoVal),
          chuva: String(chuva||''),
          gps_flag: String(gpsFlag||'')
        });
      }
    }
    out.sort((a,b)=> a.ts.localeCompare(b.ts));
    return out;
  }
  return [];
}

// ===== HELPERS =====
function json(obj, code) {
  const out = ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
  if (code && out.setResponseCode) out.setResponseCode(code);
  return out;
}
function getOrCreateSubfolder(parent, name) {
  const it = parent.getFoldersByName(name);
  if (it.hasNext()) return it.next();
  return parent.createFolder(name);
}
function sanitizeForFilename(s) {
  return s.replace(/[\\/:*?"<>|]+/g, ' ').replace(/\s+/g, '_').substring(0, 40);
}
function formatFileName(tpl, date, usuario, uuid) {
  const tz = Session.getScriptTimeZone() || 'America/Sao_Paulo';
  const y = Utilities.formatDate(date, tz, 'yyyy'), M = Utilities.formatDate(date, tz, 'MM'), d = Utilities.formatDate(date, tz, 'dd');
  const h = Utilities.formatDate(date, tz, 'HH'), m = Utilities.formatDate(date, tz, 'mm'), s = Utilities.formatDate(date, tz, 'ss');
  return tpl.replace('{YYYY}', y).replace('{MM}', M).replace('{DD}', d).replace('{hh}', h).replace('{mm}', m).replace('{ss}', s)
           .replace('{usuario}', usuario).replace('{uuid}', uuid);
}
function toNumberOrEmpty(v) {
  if (v === null || v === undefined) return '';
  const n = Number(String(v).replace(',', '.'));
  return isFinite(n) ? n : '';
}
function parseDateOrNow(s) {
  if (!s) return new Date();
  const d = new Date(String(s));
  return isNaN(d.getTime()) ? new Date() : d;
}
// "lt_08", "LT-08", "08" -> "L08"
function normalizeLot_(raw) {
  if (!raw) return null;
  const s = String(raw).trim().toUpperCase();
  if (/^L\d{2}$/.test(s)) return s;
  let m = s.match(/^LT[ _-]?(\d{2})$/); if (m) return `L${m[1]}`;
  m = s.match(/^(\d{2})$/); if (m) return `L${m[1]}`;
  return null;
}
function denormalizeLot_(L) { const m = String(L||'').toUpperCase().match(/^L(\d{2})$/); if (!m) return String(L||''); return `L${m[1]}`; }
function parsePtBrDateTime_(s){
  if (!s) return null;
  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})[ T](\d{2}):(\d{2}):(\d{2})$/);
  if (!m) return null;
  const dd=+m[1], MM=+m[2]-1, yyyy=+m[3], hh=+m[4], mm=+m[5], ss=+m[6];
  const d = new Date(yyyy,MM,dd,hh,mm,ss);
  return isNaN(d.getTime()) ? null : d;
}
function extractImageUrl_(val){
  if (!val) return '';
  const s = String(val);
  const m = s.match(/^=IMAGE\(\s*"([^"]+)"\s*\)/i);
  if (m) return m[1];
  if (/^https?:\/\//i.test(s)) return s;
  return '';
}
// "Lote 08" / "L08" / "08" -> "L08"
function normalizeLotTextToCode_(val){
  if (!val) return '';
  const s = String(val).trim();
  let m = s.match(/lote\s*0?(\d{1,3})/i); if (m) return 'L' + ('00' + m[1]).slice(-2);
  m = s.trim().toUpperCase().match(/^L0?(\d{1,3})$/); if (m) return 'L' + ('00' + m[1]).slice(-2);
  m = s.match(/^0?(\d{1,3})$/); if (m) return 'L' + ('00' + m[1]).slice(-2);
  return '';
}
// "L08" -> "Lote 08"
function normalizeLoteFromCode_(code){
  if (!code) return '';
  const m = String(code).toUpperCase().match(/^L0?(\d{1,3})$/);
  if (!m) return '';
  return 'Lote ' + ('00' + m[1]).slice(-2);
}
// "L08,L09" CSV -> Set{'L08','L09'}
function normalizeLotsCsvToSet_(csv){
  const out = new Set(); if (!csv) return out;
  String(csv).split(',').map(s => s.trim()).filter(Boolean).forEach(s => {
    const norm = normalizeLot_(s) || normalizeLotTextToCode_(s);
    if (norm) out.add(norm);
  });
  return out;
}



<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evidente ‚Ä¢ Lote 08</title>
  <style>
    :root{
      --primary:#5A8DEE;--primary-600:#4B7CE0;--success:#10B981;--danger:#EF4444;--warn:#F59E0B;--text:#0F172A;--muted:#64748B;--bg:#EEF5FF;--card:#fff;--border:#DBE6FF;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:0 auto;padding:16px}
    header{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;border-radius:12px;padding:16px 14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    h1{margin:0 0 4px;font-size:20px}
    .subtitle{opacity:.9;font-size:14px}
    .search-container{position:sticky;top:0;z-index:5;background:var(--bg);padding:10px 0}
    #search{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:16px;outline:none}
    #search:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(90,141,238,.2)}
    .buttons-container{display:grid;grid-template-columns:1fr;gap:8px;max-height:44vh;overflow:auto;margin-top:8px}
    .activity-btn{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;text-align:left;cursor:pointer;transition:.15s;box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .activity-btn strong{color:var(--primary)}
    .activity-btn:active{transform:scale(.98);background:#F4F8FF}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .section-title{margin:0 0 10px;font-weight:700}
    #camera{width:100%;aspect-ratio:4/3;background:#0b1220;border-radius:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    button{padding:12px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-ok{background:var(--success);color:#fff}
    .btn-warn{background:var(--warn);color:#fff}
    .btn-secondary{background:#94A3B8;color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    #photoCanvas{max-width:100%;border:1px solid var(--border);border-radius:10px;display:block;margin:0 auto}
    textarea{width:100%;min-height:110px;border:1px solid var(--border);border-radius:10px;padding:12px;font-size:15px}
    .muted{color:var(--muted);font-size:13px}
    .hidden{display:none!important}

    /* ===== overlay de envio ===== */
    .sending{
      position:fixed; inset:0; background:rgba(255,255,255,.85);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    .sending img{ width:min(240px,50vw); height:auto; display:block; }
    /* ===================================== */

    @media (max-width:520px){.grid2,.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Evidente ‚Äî Lote 08</h1>
    <div class="subtitle">Selecione a atividade, capture a foto e envie para a planilha</div>
  </header>

  <div class="search-container">
    <input id="search" placeholder="Buscar atividade..." autocomplete="off"/>
  </div>

  <div id="buttons-container" class="buttons-container"></div>

  <!-- C√¢mera -->
  <section id="camera-card" class="card hidden">
    <h2 class="section-title" id="camera-title">C√¢mera</h2>
    <video id="camera" autoplay playsinline></video>
    <div class="grid2" style="margin-top:10px">
      <button id="capture" class="btn-ok">Capturar Foto</button>
      <button id="close-camera" class="btn-danger">Fechar C√¢mera</button>
    </div>
    <div class="muted" id="gps-hint" style="margin-top:8px">Aguardando localiza√ß√£o‚Ä¶ permita o acesso ao GPS.</div>
  </section>

  <!-- Pr√©via -->
  <section id="preview-card" class="card hidden">
    <h2 class="section-title">Pr√©-visualiza√ß√£o</h2>
    <canvas id="photoCanvas"></canvas>
    <div style="margin-top:12px">
      <label class="muted">Observa√ß√£o (opcional)</label>
      <textarea id="comment" placeholder="Ex.: ponto com obstru√ß√£o, material recolhido, etc."></textarea>
    </div>
    <div class="grid3" style="margin-top:12px">
      <button id="save" class="btn-ok">Usar / Enviar</button>
      <button id="new-photo" class="btn-secondary">Corrigir (refazer)</button>
      <button id="cancel" class="btn-danger">Cancelar</button>
    </div>
    <div class="muted" id="status" style="margin-top:10px"></div>
  </section>
</div>

<!-- overlay com a anima√ß√£o -->
<div id="sendingOverlay" class="sending hidden" aria-hidden="true">
  <img src="send_data.gif" alt="Enviando‚Ä¶"/>
</div>

<script>
/* ====== CONFIGURE AQUI ====== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxp4jFtbtORDnpvyaHBNFkZXudJsdA6sQMm3rTEorMuAsh_5aSBl7YZMEghrZrAHJMC/exec';   // sua /exec
const APP_VERSION = '1.0';
const LOTE = '08';
/* ============================ */

// atividades (as do seu arquivo)
const atividades = [
  { cod:"421100", atividade:"CAIXA DE RETEN√á√ÉO" },
  { cod:"804300", atividade:"CAPINA MANUAL" },
  { cod:"600420", atividade:"DESOBSTRU√á√ÉO DE SARJETA" },
  { cod:"691600", atividade:"ESCAVA√á√ÉO MANUAL DE VALAS" },
  { cod:"690311", atividade:"Limpeza de bueiro / conserva√ß√£o" },
  { cod:"801200", atividade:"Limpeza de faixa de dom√≠nio" },
  { cod:"600410", atividade:"Limpeza de sarjeta" },
  { cod:"693301", atividade:"Limpeza e desobstru√ß√£o de bueiros" },
  { cod:"695059", atividade:"Limpeza e desobstru√ß√£o mecanizada" },
  { cod:"800900", atividade:"Limpeza e lava em de sinaliza√ß√£o" },
  { cod:"801100", atividade:"Limpeza e pintura de abrigo" },
  { cod:"600510", atividade:"Limpeza e pintura de meio fio" },
  { cod:"700900", atividade:"Limpeza e pintura de ponte" },
  { cod:"610200", atividade:"Limpeza manual de valeta" },
  { cod:"805460", atividade:"Poda de √°rvores" },
  { cod:"891590", atividade:"Recomposi√ß√£o de defensa met√°lica" },
  { cod:"650110", atividade:"Recomposi√ßao de sarjeta de concreto" },
  { cod:"801000", atividade:"Recomposi√ß√£o de sinaliza√ß√£o vertical" },
  { cod:"895461", atividade:"Regulariza√ß√£o mec√¢nica da faixa" },
  { cod:"895565", atividade:"Remo√ß√£o de √°rvores da pista" },
  { cod:"895660", atividade:"Remo√ß√£o de defensa met√°lica" },
  { cod:"403430", atividade:"Remo√ß√£o e transporte manual" },
  { cod:"403450", atividade:"Remo√ß√£o mecanizada barreira" },
  { cod:"890420", atividade:"Renova√ß√£o manual da sinaliza√ß√£o" },
  { cod:"801400", atividade:"Ro√ßada manual" },
  { cod:"891401", atividade:"Ro√ßada mecanizada com ro√ßadeira" },
  { cod:"795011", atividade:"Fornecimento e aplica√ß√£o de Grout" }
];

const els = {
  search: document.getElementById('search'),
  list: document.getElementById('buttons-container'),
  camCard: document.getElementById('camera-card'),
  camTitle: document.getElementById('camera-title'),
  video: document.getElementById('camera'),
  capture: document.getElementById('capture'),
  closeCam: document.getElementById('close-camera'),
  gpsHint: document.getElementById('gps-hint'),
  previewCard: document.getElementById('preview-card'),
  canvas: document.getElementById('photoCanvas'),
  comment: document.getElementById('comment'),
  save: document.getElementById('save'),
  retry: document.getElementById('new-photo'),
  cancel: document.getElementById('cancel'),
  status: document.getElementById('status'),
  sendingOverlay: document.getElementById('sendingOverlay')
};

let stream=null;
let currentActivity=null;
let currentCode=null;
let currentLat=null, currentLng=null, accuracyM=null;

document.addEventListener('DOMContentLoaded', () => {
  renderList(atividades);
  els.search.addEventListener('input', () => {
    const t = els.search.value.toLowerCase();
    const filtered = atividades.filter(a =>
      a.cod.toLowerCase().includes(t) || a.atividade.toLowerCase().includes(t)
    );
    renderList(filtered);
  });
});

function renderList(arr){
  els.list.innerHTML='';
  if(!arr.length){ els.list.innerHTML='<div class="muted">Nada encontrado.</div>'; return; }
  const frag = document.createDocumentFragment();
  arr.forEach(a=>{
    const b=document.createElement('button');
    b.className='activity-btn';
    b.innerHTML=`<strong>${a.cod}</strong> ${a.atividade}`;
    b.onclick=()=> openCamera(a);
    frag.appendChild(b);
  });
  els.list.appendChild(frag);
}

async function openCamera(atividade){
  currentActivity = atividade.atividade;
  currentCode = atividade.cod;
  els.camTitle.textContent = `${atividade.cod} ‚Äî ${atividade.atividade}`;
  els.camCard.classList.remove('hidden');
  els.previewCard.classList.add('hidden');
  els.status.textContent='';

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}}
    });
    els.video.srcObject = stream;
  }catch(err){
    alert('N√£o foi poss√≠vel abrir a c√¢mera: '+err.message);
    return;
  }

  capturePosition();
}

function capturePosition(){
  if(!('geolocation' in navigator)){
    els.gpsHint.textContent='GPS indispon√≠vel neste dispositivo.';
    return;
  }
  els.gpsHint.textContent='Capturando posi√ß√£o‚Ä¶';
  navigator.geolocation.getCurrentPosition(
    pos=>{
      currentLat = pos.coords.latitude;
      currentLng = pos.coords.longitude;
      accuracyM = Math.round(pos.coords.accuracy);
      els.gpsHint.textContent = `LAT ${currentLat.toFixed(6)}  LONG ${currentLng.toFixed(6)}  (¬±${accuracyM} m)`;
    },
    err=>{
      els.gpsHint.textContent = 'Sem acesso ao GPS (permita a localiza√ß√£o para registrar LAT/LONG).';
    },
    {enableHighAccuracy:true, timeout:8000, maximumAge:0}
  );
}

els.capture.onclick = () => {
  if(!stream){ alert('Abra a c√¢mera primeiro.'); return; }

  const w = els.video.videoWidth || 1280;
  const h = els.video.videoHeight || 720;

  els.canvas.width = w;
  els.canvas.height = h;
  const ctx = els.canvas.getContext('2d');

  ctx.drawImage(els.video, 0, 0, w, h);

  const now = new Date();
  const dateStr = now.toLocaleString();
  ctx.fillStyle='rgba(0,0,0,.35)';
  ctx.fillRect(0, h-92, w, 92);
  ctx.fillStyle='#fff';
  ctx.font='bold 22px Arial';
  ctx.fillText(`${currentCode} - ${currentActivity}`, 16, h-60);
  ctx.font='16px Arial';
  const locLine = (currentLat && currentLng)
      ? `LAT ${currentLat.toFixed(6)}  LONG ${currentLng.toFixed(6)}  (¬±${accuracyM||'?'} m)`
      : `Sem GPS`;
  ctx.fillText(`${dateStr}  ‚Ä¢  ${locLine}`, 16, h-28);

  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }

  els.camCard.classList.add('hidden');
  els.previewCard.classList.remove('hidden');
  els.previewCard.scrollIntoView({behavior:'smooth'});
};

els.retry.onclick = () => {
  openCamera({cod: currentCode, atividade: currentActivity});
};

els.cancel.onclick = () => {
  resetAll();
};

els.closeCam.onclick = () => {
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  els.camCard.classList.add('hidden');
};

els.save.onclick = async () => {
  try{
    if(!currentActivity || !currentCode){ alert('Selecione uma atividade.'); return; }

    const usuario = getUsuario();
    const obs = (els.comment.value || '').trim();
    const uuid = makeUUID();

    showSending(true);
    setStatus('Processando‚Ä¶');

    // Gera a imagem (com marca d‚Äô√°gua) em base64
    const dataURL = els.canvas.toDataURL('image/jpeg', 0.8);

    // Monta o item da fila (o m√≥dulo decide: envia j√° ou guarda offline)
    const item = {
      submission_uuid: uuid,
      app_version: APP_VERSION,
      usuario,
      lote: LOTE,
      cod_atividade: currentCode,
      atividade: currentActivity,
      obs,
      lat: currentLat ?? '',
      long: currentLng ?? '',
      accuracy_m: accuracyM ?? '',
      foto_base64: dataURL,
      created_at: Date.now(),
      WEBAPP_URL
    };

    // Usa a fila: online -> envia; offline -> guarda pend√™ncia
    const res = await window._EVIDENTE_QUEUE_OR_SEND_NOW(item);

    if(res.sent){
      setStatus('‚úÖ Enviado!');
      alert('Registro enviado!');
      resetAll();
      window.scrollTo({top:0, behavior:'smooth'});
    } else {
      setStatus('üì¶ Sem internet: registro salvo. Ser√° enviado automaticamente quando a rede voltar.');
      alert('Sem internet: pend√™ncia salva. Vamos enviar assim que a rede voltar.');
      resetAll();
      window.scrollTo({top:0, behavior:'smooth'});
    }

  }catch(err){
    console.error(err);
    setStatus('‚ùå '+err.message);
    alert('Erro: '+err.message);
  } finally {
    showSending(false);
  }
};

/* ===== helpers ===== */
function setStatus(t){ els.status.textContent=t; }
function showSending(on){ els.sendingOverlay.classList.toggle('hidden', !on); }
function getUsuario(){
  return localStorage.getItem('nome')
      || localStorage.getItem('usuario_nome')
      || localStorage.getItem('usuario')
      || 'Usu√°rio';
}
function makeUUID(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
    const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);
  });
}
// postForm pode continuar aqui (n√£o √© mais usado nesta p√°gina, mas n√£o atrapalha)
async function postForm(url, data){
  const body = new URLSearchParams();
  Object.keys(data).forEach(k=> body.append(k, data[k]));
  const resp = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: body.toString()
  });
  return resp.ok ? resp.json() : Promise.reject(new Error('Failed to fetch'));
}
function resetAll(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  currentActivity=null; currentCode=null;
  currentLat=null; currentLng=null; accuracyM=null;
  els.comment.value='';
  els.camCard.classList.add('hidden');
  els.previewCard.classList.add('hidden');
}
</script>

<!-- Importa a fila offline -->
<script type="module" src="/app-campo/queue.js"></script>
<script type="module">
  import { queueOrSendNow } from '/app-campo/queue.js';
  // exp√µe para o c√≥digo acima
  window._EVIDENTE_QUEUE_OR_SEND_NOW = queueOrSendNow;
</script>
</body>
</html>

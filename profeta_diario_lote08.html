<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evidente • Lote 08</title>
  <style>
    :root{
      --primary:#5A8DEE;--primary-600:#4B7CE0;--success:#10B981;--danger:#EF4444;--text:#0F172A;--muted:#64748B;--bg:#EEF5FF;--card:#fff;--border:#DBE6FF;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg);color:var(--text);
      padding: 18px 0 10px;             /* ↓ mais espaço no topo */
    }
    .container{max-width:900px;margin:0 auto;padding:0 16px 24px}
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary-600));
      color:#fff;border-radius:16px;padding:20px 16px;margin:0 0 16px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08)
    }
    h1{margin:0 0 6px;font-size:20px}
    .subtitle{opacity:.95;font-size:14px;line-height:1.35}
    .search-container{position:sticky;top:0;z-index:5;background:var(--bg);padding:8px 0 12px}
    #search{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:999px;
      background:#fff;font-size:16px;outline:none
    }
    #search:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(90,141,238,.2)}
    .buttons-container{
      display:grid;grid-template-columns:1fr;gap:8px;max-height:52vh;overflow:auto;margin-top:8px
    }
    .activity-btn{
      background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 14px;
      text-align:left;cursor:pointer;transition:.15s;box-shadow:0 2px 6px rgba(0,0,0,.04)
    }
    .activity-btn strong{color:var(--primary)}
    .activity-btn:active{transform:scale(.98);background:#F4F8FF}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.06)
    }
    .section-title{margin:0 0 10px;font-weight:700}
    #camera{width:100%;aspect-ratio:4/3;background:#0b1220;border-radius:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    button{padding:12px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-ok{background:var(--success);color:#fff}
    .btn-secondary{background:#94A3B8;color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    #photoCanvas{max-width:100%;border:1px solid var(--border);border-radius:10px;display:block;margin:0 auto}
    textarea{width:100%;min-height:110px;border:1px solid var(--border);border-radius:10px;padding:12px;font-size:15px}
    .muted{color:var(--muted);font-size:13px}
    .hidden{display:none!important}

    /* overlay de envio */
    .sending{
      position:fixed; inset:0; background:rgba(255,255,255,.85);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
    }
    .sending img{ width:min(240px,50vw); height:auto; display:block; }

    /* logger (debug) */
    #dbg{
      position:fixed;left:8px;right:8px;bottom:8px;
      background:#0b1220;color:#c7d2fe;border:1px solid #334155;border-radius:10px;
      padding:6px 10px;font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, monospace;z-index:9999;
      opacity:.85;max-height:28vh;overflow:auto;
    }
    #dbg b{color:#93c5fd}
    @media (max-width:520px){.grid2,.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Evidente — Lote 08</h1>
    <div class="subtitle">Selecione a atividade, capture a foto e envie para a planilha</div>
  </header>

  <div class="search-container">
    <input id="search" placeholder="Buscar atividade..." autocomplete="off"/>
  </div>

  <div id="buttons-container" class="buttons-container">
    <button class="activity-btn" disabled>Carregando atividades…</button>
  </div>

  <!-- Câmera -->
  <section id="camera-card" class="card hidden">
    <h2 class="section-title" id="camera-title">Câmera</h2>
    <video id="camera" autoplay playsinline></video>
    <div class="grid2" style="margin-top:10px">
      <button id="capture" class="btn-ok">Capturar Foto</button>
      <button id="close-camera" class="btn-danger">Fechar Câmera</button>
    </div>
    <div class="muted" id="gps-hint" style="margin-top:8px">Aguardando localização… permita o acesso ao GPS.</div>
  </section>

  <!-- Prévia -->
  <section id="preview-card" class="card hidden">
    <h2 class="section-title">Pré-visualização</h2>
    <canvas id="photoCanvas"></canvas>
    <div style="margin-top:12px">
      <label class="muted">Observação (opcional)</label>
      <textarea id="comment" placeholder="Ex.: ponto com obstrução, material recolhido, etc."></textarea>
    </div>
    <div class="grid3" style="margin-top:12px">
      <button id="save" class="btn-ok">Usar / Enviar</button>
      <button id="new-photo" class="btn-secondary">Corrigir (refazer)</button>
      <button id="cancel" class="btn-danger">Cancelar</button>
    </div>
    <div class="muted" id="status" style="margin-top:10px"></div>
  </section>
</div>

<!-- overlay com a animação -->
<div id="sendingOverlay" class="sending hidden" aria-hidden="true">
  <img src="send_data.gif" alt="Enviando…"/>
</div>

<!-- logger em tela (p/ WebView) -->
<div id="dbg">LOG — iniciando…</div>

<script>
/* ===== CONFIG ===== */
var WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxp4jFtbtORDnpvyaHBNFkZXudJsdA6sQMm3rTEorMuAsh_5aSBl7YZMEghrZrAHJMC/exec';
var APP_VERSION = '1.0';
var LOTE = '08';
/* ================== */

/* logger simples */
function dbg(msg){ try{
  var el=document.getElementById('dbg');
  el.innerHTML += '<br><b>·</b> ' + String(msg).replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s]));
  el.scrollTop = el.scrollHeight;
} catch(_){} }
window.onerror = function(m, src, ln, col){ dbg('ERRO: '+m+' @'+ln+':'+col); };

/* Lista de atividades */
var atividades = [
  { cod:"421100", atividade:"CAIXA DE RETENÇÃO" },
  { cod:"804300", atividade:"CAPINA MANUAL" },
  { cod:"600420", atividade:"DESOBSTRUÇÃO DE SARJETA" },
  { cod:"691600", atividade:"ESCAVAÇÃO MANUAL DE VALAS" },
  { cod:"690311", atividade:"Limpeza de bueiro / conservação" },
  { cod:"801200", atividade:"Limpeza de faixa de domínio" },
  { cod:"600410", atividade:"Limpeza de sarjeta" },
  { cod:"693301", atividade:"Limpeza e desobstrução de bueiros" },
  { cod:"695059", atividade:"Limpeza e desobstrução mecanizada" },
  { cod:"800900", atividade:"Limpeza e lava em de sinalização" },
  { cod:"801100", atividade:"Limpeza e pintura de abrigo" },
  { cod:"600510", atividade:"Limpeza e pintura de meio fio" },
  { cod:"700900", atividade:"Limpeza e pintura de ponte" },
  { cod:"610200", atividade:"Limpeza manual de valeta" },
  { cod:"805460", atividade:"Poda de árvores" },
  { cod:"891590", atividade:"Recomposição de defensa metálica" },
  { cod:"650110", atividade:"Recomposiçao de sarjeta de concreto" },
  { cod:"801000", atividade:"Recomposição de sinalização vertical" },
  { cod:"895461", atividade:"Regularização mecânica da faixa" },
  { cod:"895565", atividade:"Remoção de árvores da pista" },
  { cod:"895660", atividade:"Remoção de defensa metálica" },
  { cod:"403430", atividade:"Remoção e transporte manual" },
  { cod:"403450", atividade:"Remoção mecanizada barreira" },
  { cod:"890420", atividade:"Renovação manual da sinalização" },
  { cod:"801400", atividade:"Roçada manual" },
  { cod:"891401", atividade:"Roçada mecanizada com roçadeira" },
  { cod:"795011", atividade:"Fornecimento e aplicação de Grout" }
];

var els = {
  search: document.getElementById('search'),
  list: document.getElementById('buttons-container'),
  camCard: document.getElementById('camera-card'),
  camTitle: document.getElementById('camera-title'),
  video: document.getElementById('camera'),
  capture: document.getElementById('capture'),
  closeCam: document.getElementById('close-camera'),
  gpsHint: document.getElementById('gps-hint'),
  previewCard: document.getElementById('preview-card'),
  canvas: document.getElementById('photoCanvas'),
  comment: document.getElementById('comment'),
  save: document.getElementById('save'),
  retry: document.getElementById('new-photo'),
  cancel: document.getElementById('cancel'),
  status: document.getElementById('status'),
  sendingOverlay: document.getElementById('sendingOverlay')
};

var stream=null, currentActivity=null, currentCode=null;
var currentLat=null, currentLng=null, accuracyM=null;

/* ===== Init robusto ===== */
function initPage() {
  dbg('JS OK — initPage');
  try {
    renderList(atividades);
    els.search.addEventListener('input', function () {
      var t = els.search.value.toLowerCase();
      var filtered = atividades.filter(function(a){
        return a.cod.toLowerCase().indexOf(t) !== -1 || a.atividade.toLowerCase().indexOf(t) !== -1;
      });
      renderList(filtered);
    });

    setTimeout(function(){
      if (!els.list.children.length) { dbg('retry renderList'); renderList(atividades); }
    }, 350);
  } catch (e) { dbg('init erro: '+e); }
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPage, { once: true });
} else { initPage(); }

/* ===== Render ===== */
function renderList(arr){
  var html = '';
  if(!arr.length){ html = '<div class="muted">Nada encontrado.</div>'; }
  else {
    for (var i=0;i<arr.length;i++){
      html += '<button class="activity-btn" data-cod="'+arr[i].cod+'"><strong>'+arr[i].cod+'</strong> '+arr[i].atividade+'</button>';
    }
  }
  els.list.innerHTML = html;
  els.list.onclick = function(ev){
    var b = ev.target;
    while (b && !b.classList.contains('activity-btn')) b = b.parentNode;
    if (!b) return;
    var cod = b.getAttribute('data-cod');
    for (var j=0;j<atividades.length;j++){ if (atividades[j].cod === cod) { openCamera(atividades[j]); break; } }
  };
}

/* ===== Câmera (compat) ===== */
function getUserMediaCompat(constraints){
  var nav = navigator;
  if (nav.mediaDevices && nav.mediaDevices.getUserMedia) return nav.mediaDevices.getUserMedia(constraints);
  var gum = nav.getUserMedia || nav.webkitGetUserMedia || nav.mozGetUserMedia || nav.msGetUserMedia;
  if (gum) return new Promise(function(res, rej){ gum.call(nav, constraints, res, rej); });
  return Promise.reject(new Error('getUserMedia não suportado neste dispositivo'));
}

function openCamera(atividade){
  currentActivity = atividade.atividade; currentCode = atividade.cod;
  els.camTitle.textContent = atividade.cod + ' — ' + atividade.atividade;
  els.camCard.classList.remove('hidden'); els.previewCard.classList.add('hidden'); els.status.textContent='';
  dbg('abrindo câmera…');

  getUserMediaCompat({ video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}} })
    .then(function(s){ stream = s; els.video.srcObject = s; dbg('câmera ok'); })
    .catch(function(err){ alert('Não foi possível abrir a câmera: '+err.message); dbg('ERRO câmera: '+err.message); });

  capturePosition();
}

/* ===== GPS ===== */
function capturePosition(){
  if(!('geolocation' in navigator)){ els.gpsHint.textContent='GPS indisponível neste dispositivo.'; dbg('GPS indisponível'); return; }
  els.gpsHint.textContent='Capturando posição…';
  navigator.geolocation.getCurrentPosition(
    function(pos){
      currentLat = pos.coords.latitude; currentLng = pos.coords.longitude; accuracyM = Math.round(pos.coords.accuracy);
      els.gpsHint.textContent = 'LAT ' + currentLat.toFixed(6) + '  LONG ' + currentLng.toFixed(6) + '  (±' + (accuracyM||'?') + ' m)';
      dbg('GPS ok');
    },
    function(err){ els.gpsHint.textContent = 'Sem acesso ao GPS.'; dbg('ERRO GPS: '+(err&&err.message)); },
    {enableHighAccuracy:true, timeout:8000, maximumAge:0}
  );
}

/* ===== Captura frame ===== */
els.capture.onclick = function () {
  if(!stream){ alert('Abra a câmera primeiro.'); return; }
  var w = els.video.videoWidth || 1280, h = els.video.videoHeight || 720;
  els.canvas.width = w; els.canvas.height = h; var ctx = els.canvas.getContext('2d');
  ctx.drawImage(els.video, 0, 0, w, h);

  var now = new Date(), dateStr = now.toLocaleString();
  ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0, h-92, w, 92);
  ctx.fillStyle='#fff'; ctx.font='bold 22px Arial'; ctx.fillText(currentCode + ' - ' + currentActivity, 16, h-60);
  ctx.font='16px Arial';
  var locLine = (currentLat && currentLng) ? ('LAT ' + currentLat.toFixed(6) + '  LONG ' + currentLng.toFixed(6) + '  (±' + (accuracyM||'?') + ' m)') : 'Sem GPS';
  ctx.fillText(dateStr + '  •  ' + locLine, 16, h-28);

  if(stream){ try{ stream.getTracks().forEach(function(t){ t.stop(); }); }catch(_){} stream=null; }
  els.camCard.classList.add('hidden'); els.previewCard.classList.remove('hidden'); els.previewCard.scrollIntoView({behavior:'smooth'});
};

els.retry.onclick = function(){ openCamera({cod: currentCode, atividade: currentActivity}); };
els.cancel.onclick = function(){ resetAll(); };
els.closeCam.onclick = function(){ if(stream){ try{ stream.getTracks().forEach(function(t){ t.stop(); }); }catch(_){} stream=null; els.camCard.classList.add('hidden'); };

/* ===== Envio / Fila mínima ===== */
els.save.onclick = function () {
  if(!currentActivity || !currentCode){ alert('Selecione uma atividade.'); return; }
  var usuario = getUsuario(), obs = (els.comment.value || '').trim(), uuid = makeUUID();
  showSending(true); setStatus('Processando…'); dbg('enviando…');

  var dataURL = els.canvas.toDataURL('image/jpeg', 0.8);
  var item = {
    submission_uuid: uuid, app_version: APP_VERSION, usuario: usuario, lote: LOTE,
    cod_atividade: currentCode, atividade: currentActivity, obs: obs,
    lat: (currentLat!=null?currentLat:''), long: (currentLng!=null?currentLng:''), accuracy_m: (accuracyM!=null?accuracyM:''),
    foto_base64: dataURL, created_at: Date.now(), WEBAPP_URL: WEBAPP_URL
  };

  queueOrSendNowCompat(item).then(function(res){
    if(res && res.sent){ setStatus('✅ Enviado!'); alert('Registro enviado!'); }
    else { setStatus('📦 Sem internet: registro salvo.'); alert('Sem internet: pendência salva.'); }
    resetAll(); window.scrollTo({top:0, behavior:'smooth'});
  }).catch(function(err){ setStatus('❌ '+err.message); alert('Erro: '+err.message); dbg('ERRO envio: '+err.message); })
    .finally(function(){ showSending(false); });
};

/* ===== Helpers ===== */
function setStatus(t){ els.status.textContent=t; }
function showSending(on){ els.sendingOverlay.classList.toggle('hidden', !on); }
function getUsuario(){ return localStorage.getItem('nome')||localStorage.getItem('usuario_nome')||localStorage.getItem('usuario')||'Usuário'; }
function makeUUID(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);}); }
function encodeForm(data){ var p=[],k; for(k in data){ if(data.hasOwnProperty(k)){ p.push(encodeURIComponent(k)+'='+encodeURIComponent(data[k])); } } return p.join('&'); }
function postForm(url, data){
  var body = encodeForm(data);
  if (window.fetch) return fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body}).then(function(r){ if(!r.ok) throw new Error('Failed to fetch'); return r.json(); });
  return new Promise(function(resolve,reject){
    var xhr=new XMLHttpRequest(); xhr.open('POST', url, true); xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
    xhr.onreadystatechange=function(){ if(xhr.readyState===4){ if(xhr.status>=200&&xhr.status<300){ try{ resolve(JSON.parse(xhr.responseText)); }catch(e){ reject(e);} } else { reject(new Error('HTTP '+xhr.status)); } } };
    xhr.send(body);
  });
}
function resetAll(){
  if(stream){ try{ stream.getTracks().forEach(function(t){ t.stop(); }); }catch(_){} stream=null; }
  currentActivity=null; currentCode=null; currentLat=null; currentLng=null; accuracyM=null;
  els.comment.value=''; els.camCard.classList.add('hidden'); els.previewCard.classList.add('hidden');
}

/* fila simples */
function queueOrSendNowCompat(item){
  return new Promise(function(resolve){
    if (!navigator.onLine) { saveQueueItem(item); resolve({sent:false, queued:true}); return; }
    postForm(item.WEBAPP_URL, {
      action:'upload_foto', usuario:item.usuario, lote:item.lote,
      cod_atividade:item.cod_atividade, atividade:item.atividade,
      app_version:item.app_version, submission_uuid:item.submission_uuid,
      lat:item.lat, long:item.long, accuracy_m:item.accuracy_m, foto_base64:item.foto_base64
    }).then(function(up){
      if(!up || up.status!=='OK') throw new Error(up && up.mensagem ? up.mensagem : 'Falha no upload');
      return postForm(item.WEBAPP_URL, {
        action:'gravar_linha_lt08', app_version:item.app_version, usuario:item.usuario,
        cod_atividade:item.cod_atividade, atividade:item.atividade,
        foto: up.foto_url || '', foto_id: up.foto_id || '', lat:item.lat, long:item.long, obs:item.obs
      });
    }).then(function(grava){
      if(!grava || grava.status!=='OK') throw new Error(grava && grava.mensagem ? grava.mensagem : 'Falha ao gravar a linha');
      resolve({sent:true});
    }).catch(function(e){ saveQueueItem(item); resolve({sent:false, error:String(e)}); });
  });
}
function saveQueueItem(item){
  try{ var arr=[]; try{ arr=JSON.parse(localStorage.getItem('evidente_queue')||'[]'); }catch(_){}
       arr.push(item); localStorage.setItem('evidente_queue', JSON.stringify(arr)); }catch(_){}
}
/* tenta sincronizar pendências ao abrir com rede */
(function(){ try{
  if (!navigator.onLine) return;
  var arr = JSON.parse(localStorage.getItem('evidente_queue') || '[]');
  if (!arr.length) return;
  var next = arr.shift(); localStorage.setItem('evidente_queue', JSON.stringify(arr));
  queueOrSendNowCompat(next);
} catch(_){} })();
</script>

<!-- Registrar SW se abrirem direto -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/app-campo/service-worker.js').catch(function(){});
}
</script>
</body>
</html>

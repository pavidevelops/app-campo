<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Evidente ‚Ä¢ Lote 08</title>
  <style>
    :root{ --primary:#5A8DEE;--primary-600:#4B7CE0;--success:#10B981;--danger:#EF4444;--warn:#F59E0B;--text:#0F172A;--muted:#64748B;--bg:#EEF5FF;--card:#fff;--border:#DBE6FF; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:0 auto;padding:16px;padding-bottom:calc(140px + env(safe-area-inset-bottom, 0px))}
    header{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;border-radius:12px;padding:16px 14px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    h1{margin:0 0 4px;font-size:20px}
    .subtitle{opacity:.9;font-size:14px}
    .search-container{padding:10px 0}
    #search{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:16px;outline:none}
    #search:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(90,141,238,.2)}
    .buttons-container{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    .activity-btn{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;text-align:left;cursor:pointer;transition:.15s;box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .activity-btn strong{color:var(--primary)}
    .activity-btn:active{transform:scale(.98);background:#F4F8FF}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .section-title{margin:0 0 10px;font-weight:700;display:flex;align-items:center;gap:12px}
    .chk{display:inline-flex;align-items:center;gap:8px;font-weight:600;color:var(--text)}
    .chk input{width:18px;height:18px}
    #camera{width:100%;background:#0b1220;border-radius:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    button{padding:12px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-ok{background:var(--success);color:#fff}
    .btn-secondary{background:#94A3B8;color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    #photoCanvas{max-width:100%;border:1px solid var(--border);border-radius:10px;display:block;margin:0 auto}
    textarea{width:100%;min-height:110px;border:1px solid var(--border);border-radius:10px;padding:12px;font-size:15px}
    .muted{color:var(--muted);font-size:13px}
    .hidden{display:none!important}
    .sending{position:fixed;inset:0;background:rgba(255,255,255,.85);display:flex;align-items:center;justify-content:center;z-index:9999}
    .sending img{width:min(240px,50vw);height:auto;display:block}
    .toast{position:fixed;left:50%;bottom:calc(18px + env(safe-area-inset-bottom, 0px));transform:translateX(-50% ) translateY(10px);background:#0f172a;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);font-size:15px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:100000}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.ok{background:#10b981}
    .toast.err{background:#ef4444}
    @media (max-width:520px){.grid2,.grid3{grid-template-columns:1fr}}
    .safe-bottom{height:calc(80px + env(safe-area-inset-bottom, 0px))}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Evidente ‚Äî <span id="loteAtual">Lote 08</span></h1>
    <div class="subtitle">Selecione a atividade, capture a foto e envie para a planilha</div>
  </header>

  <div id="searchWrap" class="search-container">
    <input id="search" placeholder="Buscar atividade..." autocomplete="off"/>
  </div>

  <div id="listWrap" class="buttons-container"></div>

  <!-- C√¢mera -->
  <section id="camera-card" class="card hidden">
    <h2 class="section-title" id="camera-title">C√¢mera</h2>
    <video id="camera" autoplay playsinline muted></video>
    <div class="grid2" style="margin-top:10px">
      <button id="capture" class="btn-ok">Capturar Foto</button>
      <button id="close-camera" class="btn-danger">Fechar C√¢mera</button>
    </div>
    <div class="muted" id="gps-hint" style="margin-top:8px">Aguardando localiza√ß√£o‚Ä¶ permita o acesso ao GPS.</div>
  </section>

  <!-- Pr√©via -->
  <section id="preview-card" class="card hidden">
    <h2 class="section-title">
      Pr√©-visualiza√ß√£o
      <label class="chk"><input type="checkbox" id="rainChk"> chuva</label>
    </h2>
    <canvas id="photoCanvas"></canvas>
    <div style="margin-top:12px">
      <label class="muted">Observa√ß√£o (opcional)</label>
      <textarea id="comment" placeholder="Ex.: ponto com obstru√ß√£o, material recolhido, etc."></textarea>
    </div>
    <div class="grid3" style="margin-top:12px">
      <button id="save" class="btn-ok">Usar / Enviar</button>
      <button id="new-photo" class="btn-secondary">Corrigir (refazer)</button>
      <button id="cancel" class="btn-danger">Cancelar</button>
    </div>
    <div class="muted" id="status" style="margin-top:10px"></div>
  </section>

  <div class="safe-bottom" aria-hidden="true"></div>
</div>

<div id="sendingOverlay" class="sending hidden" aria-hidden="true">
  <img src="send_data.gif" alt="Enviando‚Ä¶"/>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ====== CONFIG ====== */
var WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxLlH7_g3QdHTgFM5tV3suk8Tmjdi3iSmVa5BEg-paUra-CLuwyo9zpj1iEz1jaFF2t/exec';
var APP_VERSION = '1.0';
/* ==================== */

/* Resolve LOTE_NOME/LOTE_COD do localStorage ou pelo nome do arquivo */
(function resolveLot(){
  function pad2(n){ return String(n).padStart(2,'0'); }
  var lsNome = localStorage.getItem('EVIDENTE_LOTE_NOME');
  var lsCod  = localStorage.getItem('EVIDENTE_LOTE_COD');
  if (!lsNome || !lsCod){
    var m = location.pathname.match(/lote(\d{2,3})/i);
    var num = m ? pad2(m[1]) : '08';
    lsNome = lsNome || ('Lote ' + num);
    lsCod  = lsCod  || ('L' + num);
    localStorage.setItem('EVIDENTE_LOTE_NOME', lsNome);
    localStorage.setItem('EVIDENTE_LOTE_COD',  lsCod);
  }
  window.LOTE_NOME = lsNome; // "Lote 08"
  window.LOTE_COD  = lsCod;  // "L08"
  document.getElementById('loteAtual').textContent = LOTE_NOME;
})();

/* Hook opcional para WebView marcar fake GPS */
window.__EVIDENTE_MOCK = false;
window.Evidente = window.Evidente || {};
window.Evidente.setMockGps = function(isMock){ window.__EVIDENTE_MOCK = !!isMock; };

/* atividades (fixas) */
var atividades = [
  { cod:"421100", atividade:"CAIXA DE RETEN√á√ÉO" },
  { cod:"804300", atividade:"CAPINA MANUAL" },
  { cod:"600420", atividade:"DESOBSTRU√á√ÉO DE SARJETA" },
  { cod:"691600", atividade:"ESCAVA√á√ÉO MANUAL DE VALAS" },
  { cod:"690311", atividade:"Limpeza de bueiro / conserva√ß√£o" },
  { cod:"801200", atividade:"Limpeza de faixa de dom√≠nio" },
  { cod:"600410", atividade:"Limpeza de sarjeta" },
  { cod:"693301", atividade:"Limpeza e desobstru√ß√£o de bueiros" },
  { cod:"695059", atividade:"Limpeza e desobstru√ß√£o mecanizada" },
  { cod:"800900", atividade:"Limpeza e lava em de sinaliza√ß√£o" },
  { cod:"801100", atividade:"Limpeza e pintura de abrigo" },
  { cod:"600510", atividade:"Limpeza e pintura de meio fio" },
  { cod:"700900", atividade:"Limpeza e pintura de ponte" },
  { cod:"610200", atividade:"Limpeza manual de valeta" },
  { cod:"805460", atividade:"Poda de √°rvores" },
  { cod:"891590", atividade:"Recomposi√ß√£o de defensa met√°lica" },
  { cod:"650110", atividade:"Recomposi√ßao de sarjeta de concreto" },
  { cod:"801000", atividade:"Recomposi√ß√£o de sinaliza√ß√£o vertical" },
  { cod:"895461", atividade:"Regulariza√ß√£o mec√¢nica da faixa" },
  { cod:"895565", atividade:"Remo√ß√£o de √°rvores da pista" },
  { cod:"895660", atividade:"Remo√ß√£o de defensa met√°lica" },
  { cod:"403430", atividade:"Remo√ß√£o e transporte manual" },
  { cod:"403450", atividade:"Remo√ß√£o mecanizada barreira" },
  { cod:"890420", atividade:"Renova√ß√£o manual da sinaliza√ß√£o" },
  { cod:"801400", atividade:"Ro√ßada manual" },
  { cod:"891401", atividade:"Ro√ßada mecanizada com ro√ßadeira" },
  { cod:"795011", atividade:"Fornecimento e aplica√ß√£o de Grout" }
];

/* refs e estados */
var els = {
  searchWrap: document.getElementById('searchWrap'),
  listWrap: document.getElementById('listWrap'),
  search: document.getElementById('search'),
  list: document.getElementById('listWrap'),
  camCard: document.getElementById('camera-card'),
  camTitle: document.getElementById('camera-title'),
  video: document.getElementById('camera'),
  capture: document.getElementById('capture'),
  closeCam: document.getElementById('close-camera'),
  gpsHint: document.getElementById('gps-hint'),
  previewCard: document.getElementById('preview-card'),
  canvas: document.getElementById('photoCanvas'),
  comment: document.getElementById('comment'),
  save: document.getElementById('save'),
  retry: document.getElementById('new-photo'),
  cancel: document.getElementById('cancel'),
  status: document.getElementById('status'),
  sendingOverlay: document.getElementById('sendingOverlay'),
  rainChk: document.getElementById('rainChk')
};
var stream=null, currentActivity=null, currentCode=null;
var currentLat=null, currentLng=null, accuracyM=null;
var fixLat=null, fixLng=null, fixAcc=null;

/* UI */
function showToast(text, type) {
  var el = document.getElementById('toast'); if (!el) return;
  el.textContent = text; el.className = 'toast ' + (type === 'err' ? 'err' : 'ok');
  void el.offsetWidth; el.classList.add('show');
  setTimeout(function(){ el.classList.remove('show'); }, 2200);
}
function init(){
  renderList(atividades);
  els.search.value = '';
  els.search.addEventListener('input', function(){
    var t = els.search.value.toLowerCase();
    renderList(atividades.filter(a => a.cod.toLowerCase().includes(t) || a.atividade.toLowerCase().includes(t)));
  });
}
if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }

function renderList(arr){
  els.list.innerHTML=''; if(!arr.length){ els.list.innerHTML='<div class="muted">Nada encontrado.</div>'; return; }
  arr.forEach(function(a){
    var b=document.createElement('button'); b.className='activity-btn';
    b.innerHTML='<strong>'+a.cod+'</strong> '+a.atividade;
    b.onclick=function(){ openCamera(a); }; els.list.appendChild(b);
  });
}

/* util */
function scrollToShow(el, offset){
  try{ var rect = el.getBoundingClientRect();
    var top = (window.pageYOffset || document.documentElement.scrollTop || 0) + rect.top - (offset||8);
    window.scrollTo({ top: top, behavior: 'smooth' }); }catch(e){}
}
function getUserMediaCompat(c){
  var nav = navigator;
  if (nav.mediaDevices && nav.mediaDevices.getUserMedia) return nav.mediaDevices.getUserMedia(c);
  var gum = nav.getUserMedia || nav.webkitGetUserMedia || nav.mozGetUserMedia || nav.msGetUserMedia;
  if (gum) return new Promise(function(res, rej){ gum.call(nav, c, res, rej); });
  return Promise.reject(new Error('getUserMedia n√£o suportado'));
}

/* c√¢mera */
function openCamera(atividade){
  currentActivity = atividade.atividade; currentCode = atividade.cod;
  els.camTitle.textContent = atividade.cod+' ‚Äî '+atividade.atividade;
  els.searchWrap.style.display = 'none'; els.list.style.display = 'none';
  els.camCard.classList.remove('hidden'); els.previewCard.classList.add('hidden'); els.status.textContent='';
  try { els.video.muted = true; } catch(e) {}

  getUserMediaCompat({ video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}} })
    .then(function(s){ stream = s; els.video.srcObject = s; els.video.onloadedmetadata = function(){
      try { var p = els.video.play(); if (p && p.catch) p.catch(function(){}); } catch(e){}
      scrollToShow(els.camCard, 10); }; setTimeout(function(){ scrollToShow(els.camCard, 10); }, 300);
    })
    .catch(function(err){ showToast('N√£o foi poss√≠vel abrir a c√¢mera: ' + err.message, 'err'); restoreList(); });

  startLivePosition();
}
function restoreList(){
  els.searchWrap.style.display = ''; els.list.style.display = '';
  els.search.value = ''; renderList(atividades); window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* GPS */
function startLivePosition(){
  if(!('geolocation' in navigator)){ els.gpsHint.textContent='GPS indispon√≠vel.'; return; }
  els.gpsHint.textContent='Capturando posi√ß√£o‚Ä¶';
  navigator.geolocation.getCurrentPosition(function(pos){
    currentLat = pos.coords.latitude; currentLng = pos.coords.longitude; accuracyM = Math.round(pos.coords.accuracy||0);
    els.gpsHint.textContent = 'LAT '+currentLat.toFixed(6)+'  LONG '+currentLng.toFixed(6)+'  (¬±'+(accuracyM||'?')+' m)';
  }, function(){ els.gpsHint.textContent = 'Sem acesso ao GPS (permita localiza√ß√£o).'; }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
}
function getFreshFix(targetAcc, maxWaitMs){
  targetAcc = targetAcc || 25; maxWaitMs = maxWaitMs || 8000;
  return new Promise(function(resolve, reject){
    if(!('geolocation' in navigator)) return reject(new Error('GPS indispon√≠vel'));
    var best = null, cleared=false;
    function clearAll(){ if(cleared) return; cleared=true; try{ navigator.geolocation.clearWatch(wid); }catch(e){} clearTimeout(tid); }
    function better(a,b){ if(!a) return b; if(!a.coords.accuracy) return b; if(!b.coords.accuracy) return a; return (b.coords.accuracy <= a.coords.accuracy) ? b : a; }
    var wid = navigator.geolocation.watchPosition(function(pos){
      best = better(best, pos); var acc = Math.round(pos.coords.accuracy||0);
      els.gpsHint.textContent = 'Precis√£o '+acc+' m ‚Äî fixando localiza√ß√£o‚Ä¶';
      if (acc && acc <= targetAcc){ clearAll(); resolve(best); }
    }, function(){}, {enableHighAccuracy:true, maximumAge:0});
    var tid = setTimeout(function(){ clearAll();
      if (best) return resolve(best);
      navigator.geolocation.getCurrentPosition(function(pos){ resolve(pos); }, function(e){ reject(e); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }, maxWaitMs);
  });
}

/* CAPTURA */
document.getElementById('capture').onclick = function(){
  if(!stream){ showToast('Abra a c√¢mera primeiro.', 'err'); return; }
  this.disabled = true; this.textContent = 'Aguarde, capturando imagens...'; els.gpsHint.textContent = 'Buscando coordenadas precisas‚Ä¶';

  getFreshFix(25, 8000)
    .then(function(pos){ fixLat = pos.coords.latitude; fixLng = pos.coords.longitude; fixAcc = Math.round(pos.coords.accuracy||0);
      els.gpsHint.textContent = 'Fix obtido: LAT '+fixLat.toFixed(6)+'  LONG '+fixLng.toFixed(6)+'  (¬±'+fixAcc+' m)'; })
    .catch(function(){ fixLat = currentLat; fixLng = currentLng; fixAcc = accuracyM;
      els.gpsHint.textContent = fixLat && fixLng ? 'Usando leitura atual: LAT '+fixLat.toFixed(6)+'  LONG '+fixLng.toFixed(6)+'  (¬±'+(fixAcc||'?')+' m)' : 'Sem GPS ‚Äî registrando sem coordenadas'; })
    .finally(function(){
      var w = els.video.videoWidth || 1280, h = els.video.videoHeight || 720;
      els.canvas.width = w; els.canvas.height = h; var ctx = els.canvas.getContext('2d'); ctx.drawImage(els.video, 0, 0, w, h);
      var now = new Date(), dateStr = now.toLocaleString();
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0, h-92, w, 92);
      ctx.fillStyle='#fff'; ctx.font='bold 22px Arial'; ctx.fillText(currentCode+' - '+currentActivity, 16, h-60);
      ctx.font='16px Arial'; var locLine = (fixLat && fixLng) ? ('LAT '+fixLat.toFixed(6)+'  LONG '+fixLng.toFixed(6)+'  (¬±'+(fixAcc||'?')+' m)') : 'Sem GPS';
      ctx.fillText(dateStr+'  ‚Ä¢  '+locLine, 16, h-28);
      if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; }
      els.camCard.classList.add('hidden'); els.previewCard.classList.remove('hidden'); scrollToShow(els.previewCard, 10);
      var c = document.getElementById('capture'); c.disabled = false; c.textContent = 'Capturar Foto';
    });
};

document.getElementById('new-photo').onclick = function(){ openCamera({cod: currentCode, atividade: currentActivity}); };
document.getElementById('cancel').onclick    = function(){ resetAll(); };
document.getElementById('close-camera').onclick = function(){
  if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; }
  els.camCard.classList.add('hidden'); restoreList(); window.scrollTo({top:0, behavior:'smooth'});
};

/* Envio (fila/offline se dispon√≠vel) */
document.getElementById('save').onclick = function () {
  try{
    if(!currentActivity || !currentCode){ showToast('Selecione uma atividade.', 'err'); return; }
    var usuario = localStorage.getItem('nome')||localStorage.getItem('usuario_nome')||localStorage.getItem('usuario')||'Usu√°rio';
    var obs = (els.comment.value || '').trim();
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});
    var chuvaVal = els.rainChk.checked ? 'SIM' : '';
    var gpsFlag = (window.__EVIDENTE_MOCK === true) ? 'FAKE GPS' : '';
    showSending(true); setStatus('Preparando registro‚Ä¶');
    var dataURL = els.canvas.toDataURL('image/jpeg', 0.8);

    var item = {
      submission_uuid: uuid,
      app_version: APP_VERSION,
      usuario: usuario,
      lote: LOTE_NOME, lote_cod: LOTE_COD,
      cod_atividade: currentCode, atividade: currentActivity,
      obs: obs, chuva: chuvaVal,
      fake_gps: gpsFlag, gps_flag: gpsFlag,
      lat: (fixLat!=null?fixLat:''), long: (fixLng!=null?fixLng:''), accuracy_m: (fixAcc!=null?fixAcc:''),
      foto_base64: dataURL, created_at: Date.now(), WEBAPP_URL: WEBAPP_URL
    };

    if (window.EvidenteQueue && window.EvidenteQueue.queueOrSendNow) {
      window.EvidenteQueue.queueOrSendNow(item, {
        onSent: function(){ setStatus('‚úÖ Enviado com sucesso!'); showToast('Registro enviado','ok'); resetAll(); window.scrollTo({top:0,behavior:'smooth'}); showSending(false); },
        onQueued: function(){ setStatus('üì¶ Sem internet: registro salvo.'); showToast('Sem internet: registro salvo','ok'); resetAll(); window.scrollTo({top:0,behavior:'smooth'}); showSending(false); }
      });
      return;
    }

    // Sem fila: envia direto (upload_foto -> gravar_linha_lt08)
    postFormXHR(WEBAPP_URL, {
      action:'upload_foto', usuario:usuario, lote: LOTE_NOME,
      cod_atividade: currentCode, atividade: currentActivity,
      app_version: APP_VERSION, submission_uuid: uuid,
      lat: item.lat, long: item.long, accuracy_m: item.accuracy_m,
      foto_base64: dataURL
    }, function(up){
      if(!up || up.status!=='OK'){ throwSend('Falha no upload da foto'); return; }
      setStatus('Enviando dados‚Ä¶');
      postFormXHR(WEBAPP_URL, {
        action:'gravar_linha_lt08',
        app_version: APP_VERSION, usuario: usuario,
        cod_atividade: currentCode, atividade: currentActivity,
        foto: up.foto_url || '', foto_id: up.foto_id || '',
        lat: item.lat, long: item.long, obs: obs,
        chuva: chuvaVal, fake_gps: gpsFlag,
        lote: LOTE_NOME   // <<< vai para a COLUNA L
      }, function(grava){
        if(!grava || grava.status!=='OK'){ throwSend('Falha ao gravar a linha'); return; }
        setStatus('‚úÖ Enviado com sucesso!'); showToast('Registro enviado','ok'); resetAll(); window.scrollTo({top:0,behavior:'smooth'}); showSending(false);
      }, function(e2){ throwSend(e2); });
    }, function(e1){ throwSend(e1); });

  }catch(err){ setStatus('‚ùå '+err); showToast('Erro: '+err,'err'); showSending(false); }
};

function setStatus(t){ els.status.textContent = t; scrollToShow(els.status, 140); }
function showSending(on){ els.sendingOverlay.classList.toggle('hidden', !on); }
function throwSend(msg){ setStatus('‚ùå '+msg); showToast('Erro: '+msg,'err'); showSending(false); }
function postFormXHR(url, data, ok, err){
  try{
    var xhr=new XMLHttpRequest(); xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
    xhr.onreadystatechange=function(){ if(xhr.readyState===4){
      if(xhr.status>=200 && xhr.status<300){ try{ ok(JSON.parse(xhr.responseText)); }catch(e){ err('Resposta inv√°lida'); } }
      else{ err('HTTP '+xhr.status); } } };
    xhr.onerror=function(){ err('Falha de rede'); };
    xhr.send(Object.keys(data).map(k => encodeURIComponent(k)+'='+encodeURIComponent(data[k])).join('&'));
  }catch(e){ err(String(e)); }
}
function resetAll(){
  if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream=null; }
  currentActivity=null; currentCode=null; currentLat=null; currentLng=null; accuracyM=null; fixLat=null; fixLng=null; fixAcc=null;
  els.rainChk.checked = false; els.comment.value=''; els.camCard.classList.add('hidden'); els.previewCard.classList.add('hidden'); restoreList();
}
</script>

<!-- Fila offline (se estiver usando) -->
<script src="./queue.js"></script>
</body>
</html>



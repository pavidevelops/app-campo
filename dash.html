<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Evidente • Dashboard</title>
<style>
  :root{
    --bg:#eef5ff; --card:#fff; --text:#0f172a; --muted:#6b7280;
    --primary:#5a8dee; --primary-600:#4b7ce0; --border:#dbe6ff;
    --ok:#059669; --warn:#d97706; --err:#b91c1c;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;padding:16px}
  h1{margin:0;font-size:20px}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,button{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;outline:none}
  button.primary{background:var(--primary);color:#fff;border:0;font-weight:700}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 4px;font-size:13px;color:var(--muted)}
  .kpi .v{font-size:24px;font-weight:800}
  .bars{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .barlist .item{margin:6px 0}
  .barlist .label{font-size:12px;color:var(--muted)}
  .barlist .bar{height:10px;background:#e5edff;border-radius:999px;overflow:hidden}
  .barlist .bar>i{display:block;height:100%;background:var(--primary)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;font-size:14px}
  th{background:#f6f9ff;text-align:left}
  .muted{color:var(--muted)}
  .row-actions{display:flex;gap:8px}
  @media (max-width:900px){
    .filters{grid-template-columns:1fr 1fr 1fr}
    .kpis{grid-template-columns:1fr 1fr}
    .bars{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <h1>Evidente — Dashboard</h1>
  <div class="muted">Visão geral e por lote • Atualize os dados por período</div>
</header>

<div class="container">
  <section class="card">
    <div class="filters">
      <div>
        <label for="lote">Lote</label>
        <select id="lote">
          <option value="all">Todos</option>
          <option value="08">Lote 08</option>
          <!-- Quando criar novos, adicione aqui (ou podemos preencher via API no futuro) -->
        </select>
      </div>
      <div>
        <label for="dateFrom">De (data)</label>
        <input type="date" id="dateFrom">
      </div>
      <div>
        <label for="dateTo">Até (data)</label>
        <input type="date" id="dateTo">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnRefresh" class="primary">Atualizar</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnCsv">Exportar CSV</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="kpis">
      <div class="kpi"><h3>Total de registros</h3><div id="kpiTotal" class="v">–</div></div>
      <div class="kpi"><h3>Chuva (SIM)</h3><div id="kpiChuva" class="v">–</div></div>
      <div class="kpi"><h3>Usuários únicos</h3><div id="kpiUsers" class="v">–</div></div>
      <div class="kpi"><h3>Atividades únicas</h3><div id="kpiAtvs" class="v">–</div></div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">Série diária</h3>
    <div id="seriesDia" class="barlist"></div>
  </section>

  <section class="card">
    <div class="bars">
      <div>
        <h3 style="margin:0 0 8px">Top 10 Atividades</h3>
        <div id="topAtividades" class="barlist"></div>
      </div>
      <div>
        <h3 style="margin:0 0 8px">Top 10 Usuários</h3>
        <div id="topUsuarios" class="barlist"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">Registros recentes</h3>
      <span id="rowsInfo" class="muted"></span>
    </div>
    <div style="overflow:auto">
      <table id="rowsTable">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Lote</th>
            <th>Usuário</th>
            <th>Código</th>
            <th>Atividade</th>
            <th>Chuva</th>
            <th>Lat</th>
            <th>Long</th>
            <th>Foto</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ====== CONFIGURE AQUI ====== */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxp4jFtbtORDnpvyaHBNFkZXudJsdA6sQMm3rTEorMuAsh_5aSBl7YZMEghrZrAHJMC/exec';
/* ============================ */

const els = {
  lote: document.getElementById('lote'),
  dateFrom: document.getElementById('dateFrom'),
  dateTo: document.getElementById('dateTo'),
  btnRefresh: document.getElementById('btnRefresh'),
  btnCsv: document.getElementById('btnCsv'),
  kpiTotal: document.getElementById('kpiTotal'),
  kpiChuva: document.getElementById('kpiChuva'),
  kpiUsers: document.getElementById('kpiUsers'),
  kpiAtvs: document.getElementById('kpiAtvs'),
  seriesDia: document.getElementById('seriesDia'),
  topAtividades: document.getElementById('topAtividades'),
  topUsuarios: document.getElementById('topUsuarios'),
  rowsTableBody: document.querySelector('#rowsTable tbody'),
  rowsInfo: document.getElementById('rowsInfo'),
};

function encodeForm(data){
  const p = [];
  for (const k in data) if (Object.prototype.hasOwnProperty.call(data,k)) {
    p.push(encodeURIComponent(k)+'='+encodeURIComponent(data[k]));
  }
  return p.join('&');
}
function postJSON(action, payload){
  const body = encodeForm(Object.assign({action}, payload||{}));
  return fetch(WEBAPP_URL, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body
  }).then(async resp=>{
    const txt = await resp.text();
    try{ return JSON.parse(txt); }catch(_){ throw new Error('Resposta inválida'); }
  });
}

function humanDate(iso){
  if(!iso) return '';
  const d = new Date(iso);
  if (isNaN(d.getTime())) return '';
  return d.toLocaleString();
}

function renderBars(container, items, labelFn, valueFn, maxItems){
  container.innerHTML = '';
  const data = (items || []).slice(0, maxItems || 10);
  const max = data.reduce((m,it)=>Math.max(m, valueFn(it)||0), 1);
  data.forEach(it=>{
    const val = valueFn(it)||0;
    const pct = Math.round((val/max)*100);
    const wrap = document.createElement('div');
    wrap.className = 'item';
    wrap.innerHTML = `
      <div class="label">${labelFn(it)} <span class="muted">(${val})</span></div>
      <div class="bar"><i style="width:${pct}%"></i></div>
    `;
    container.appendChild(wrap);
  });
  if (!data.length){
    container.innerHTML = '<div class="muted">Sem dados.</div>';
  }
}

function renderTable(rows){
  els.rowsTableBody.innerHTML = '';
  (rows || []).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${humanDate(r.data_hora_iso)}</td>
      <td>${r.lote}</td>
      <td>${r.usuario || ''}</td>
      <td>${r.cod_atividade || ''}</td>
      <td>${r.atividade || ''}</td>
      <td>${r.chuva || ''}</td>
      <td>${r.lat || ''}</td>
      <td>${r.long || ''}</td>
      <td>${r.foto_url ? `<a href="${r.foto_url}" target="_blank">ver</a>` : ''}</td>
      <td>${(r.obs||'').replace(/</g,'&lt;')}</td>
    `;
    els.rowsTableBody.appendChild(tr);
  });
}

function cacheKey(scope, from, to){ return `dash_cache_${scope}_${from||''}_${to||''}`; }
function saveCache(scope, from, to, stats, rows){
  try{
    localStorage.setItem(cacheKey(scope, from, to), JSON.stringify({stats, rows, ts: Date.now()}));
  }catch(_){}
}
function loadCache(scope, from, to){
  try{
    const s = localStorage.getItem(cacheKey(scope, from, to));
    return s ? JSON.parse(s) : null;
  }catch(_){ return null; }
}

async function refresh(){
  const scope = els.lote.value || 'all';
  const df = els.dateFrom.value || '';
  const dt = els.dateTo.value   || '';

  try{
    const [stats, list] = await Promise.all([
      postJSON('get_stats', {lote: scope, date_from: df, date_to: dt}),
      postJSON('list_rows', {lote: scope, date_from: df, date_to: dt, limit: 200, offset: 0})
    ]);

    if (stats.status !== 'OK') throw new Error(stats.mensagem || 'Falha nas estatísticas');
    if (list.status  !== 'OK') throw new Error(list.mensagem  || 'Falha na lista');

    // KPIs
    els.kpiTotal.textContent = stats.totals.registros;
    els.kpiChuva.textContent = stats.totals.chuvaSim;
    els.kpiUsers.textContent = stats.totals.usuariosUnicos;
    els.kpiAtvs.textContent  = stats.totals.atividadesUnicas;

    // Barras
    renderBars(els.seriesDia, stats.seriesDia, it=>it.date, it=>it.count, 30);
    renderBars(els.topAtividades, stats.topAtividades, it=>`${it.cod} — ${it.atividade}`, it=>it.count, 10);
    renderBars(els.topUsuarios,   stats.topUsuarios,   it=>it.usuario||'(vazio)', it=>it.count, 10);

    // Tabela
    renderTable(list.rows);
    els.rowsInfo.textContent = `${list.count} de ${list.total}`;

    // Cache offline
    saveCache(scope, df, dt, stats, list.rows);

    // Lotes disponíveis (preencher select se mudar)
    if (Array.isArray(stats.lotesDisponiveis)) {
      const current = els.lote.value;
      const want = ['all'].concat(stats.lotesDisponiveis);
      els.lote.innerHTML = want.map(v=>{
        if (v==='all') return `<option value="all">Todos</option>`;
        return `<option value="${v}">Lote ${v}</option>`;
      }).join('');
      els.lote.value = want.includes(current) ? current : 'all';
    }
  }catch(err){
    // Tenta cache
    const c = loadCache(scope, df, dt);
    if (c){
      els.kpiTotal.textContent = c.stats.totals.registros;
      els.kpiChuva.textContent = c.stats.totals.chuvaSim;
      els.kpiUsers.textContent = c.stats.totals.usuariosUnicos;
      els.kpiAtvs.textContent  = c.stats.totals.atividadesUnicas;
      renderBars(els.seriesDia, c.stats.seriesDia, it=>it.date, it=>it.count, 30);
      renderBars(els.topAtividades, c.stats.topAtividades, it=>`${it.cod} — ${it.atividade}`, it=>it.count, 10);
      renderBars(els.topUsuarios,   c.stats.topUsuarios,   it=>it.usuario||'(vazio)', it=>it.count, 10);
      renderTable(c.rows);
      els.rowsInfo.textContent = `${c.rows.length} (offline)`;
      alert('Sem conexão ao servidor. Exibindo dados salvos.');
    } else {
      alert('Erro ao carregar dashboard: ' + err.message);
    }
  }
}

// CSV simples da tabela atual
function exportCSV(){
  const rows = Array.from(document.querySelectorAll('#rowsTable tbody tr'))
    .map(tr => Array.from(tr.children).map(td => `"${(td.textContent||'').replace(/"/g,'""')}"`).join(','));
  const header = ['Data/Hora','Lote','Usuário','Código','Atividade','Chuva','Lat','Long','Foto','Obs'].join(',');
  const csv = [header].concat(rows).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'evidente_dashboard.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Eventos
els.btnRefresh.addEventListener('click', refresh);
els.btnCsv.addEventListener('click', exportCSV);

// Querystring -> pré-selecionar lote (ex.: dashboard.html?lote=08)
(function initFromQS(){
  const qs = new URLSearchParams(location.search);
  const l = qs.get('lote');
  if (l) els.lote.value = l;
})();

// Auto-carregar
refresh();
</script>
</body>
</html>
